import React, { useState, useRef } from "react";
import "./App.css";
import ImageUploadForm from "./ImageUploadForm";
import ImageCanvas from "./ImageCanvas";
import Controller from "./Controller";

const createObjectURL =
  (window.URL || window.webkitURL).createObjectURL || window.createObjectURL;

const App = () => {
  const imageFileInitialValue = { url: "", width: NaN, height: NaN };
  const [imageFile, setImageFile] = useState(imageFileInitialValue);
  // const [canvas, updateCanvas] = useState(null);
  const [boardFormat, setBoard] = useState([
    {
      id: 0,
      name: "ホワイトボード",
      svgCode: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 480"><rect width="640" height="480" style="fill:#fff"/><path d="M624,16V464H16V16H624m4-4H12V468H628V12Z"/><line x1="12" y1="83.5" x2="628" y2="83.5" style="fill:none;stroke:#000;stroke-miterlimit:10;stroke-width:2px"/><line x1="12" y1="155.5" x2="628" y2="155.5" style="fill:none;stroke:#000;stroke-miterlimit:10;stroke-width:2px"/><line x1="12" y1="227.5" x2="628" y2="227.5" style="fill:none;stroke:#000;stroke-miterlimit:10;stroke-width:2px"/><line x1="252" y1="227" x2="252" y2="12" style="fill:none;stroke:#000;stroke-miterlimit:10;stroke-width:2px"/><path d="M90.43,72.87a2.41,2.41,0,0,1-2.38,2.38H38.82a2.41,2.41,0,0,1-2.38-2.38,2.37,2.37,0,0,1,2.38-2.38H61.06V29.93H42.71a2.38,2.38,0,0,1,0-4.76H84.16a2.38,2.38,0,0,1,0,4.76H65.81V70.49H88.05A2.37,2.37,0,0,1,90.43,72.87Z"/><path d="M160.45,57.72a2.36,2.36,0,0,1-2.37,2.38H153v3.84a4,4,0,0,1-4,4H131.81v6.61a6,6,0,0,1-2.18,4.7,6.08,6.08,0,0,1-3.89,1.39,6,6,0,0,1-1.12-.07,30.33,30.33,0,0,1-8.91-3.3,2.36,2.36,0,0,1-.93-3.25,2.31,2.31,0,0,1,3.17-.92,24.73,24.73,0,0,0,7.52,2.78,1.39,1.39,0,0,0,1.13-.27,1.43,1.43,0,0,0,.46-1.06V67.91H108.18a2.39,2.39,0,0,1,0-4.77h18.88v-3H100.79a2.36,2.36,0,0,1-2.37-2.38,2.4,2.4,0,0,1,2.37-2.38h26.27v-3H108.18a2.38,2.38,0,0,1,0-4.76h18.88V44.82H109.77a4,4,0,0,1-4-4v-5.3a4,4,0,0,1,4-4h17.29V28.81H103.37a2.39,2.39,0,0,1,0-4.77h23.69V20.73a2.38,2.38,0,1,1,4.75,0V24H155.5a2.39,2.39,0,0,1,0,4.77H131.81v2.77H149.1a4,4,0,0,1,4,4v5.3a4,4,0,0,1-4,4H131.81V47.6H149a4,4,0,0,1,4,4v3.77h5.09A2.4,2.4,0,0,1,160.45,57.72ZM127.06,40.05v-3.7h-16.5v3.7Zm4.75-3.7v3.7h16.5v-3.7Zm0,19h16.43v-3H131.81Zm16.43,4.76H131.81v3h16.43Z"/><path d="M223,54.87V73.33a4,4,0,0,1-4,4H192.07a4,4,0,0,1-4-4V54.87a3.84,3.84,0,0,1,1.58-3.11,113.73,113.73,0,0,1-20.13,10.06,3.57,3.57,0,0,1-.85.13,2.4,2.4,0,0,1-.79-4.63,99.2,99.2,0,0,0,13.92-6.48c3.7-2.05,7.39-4.37,10.95-6.82a46.59,46.59,0,0,0-8.31-7.41,2.37,2.37,0,0,1,2.71-3.9,50.28,50.28,0,0,1,9.43,8.53,91.22,91.22,0,0,0,10-8.66,30.74,30.74,0,0,0,6-8H192.46a59,59,0,0,1-18.28,11.25,2.47,2.47,0,0,1-3.1-1.32,2.42,2.42,0,0,1,1.32-3.11,53.59,53.59,0,0,0,17-10.39,4.12,4.12,0,0,1,3-1.19H213a4.47,4.47,0,0,1,3.76,2.05,4.41,4.41,0,0,1,.4,4.23c-3.3,7.61-13.2,15.68-18.88,19.85a.84.84,0,0,1-.26.2l-.27.26a1.85,1.85,0,0,1-.52.27c-2.25,1.65-4.56,3.17-6.87,4.7a3.89,3.89,0,0,1,1.72-.47H219A4,4,0,0,1,223,54.87Zm-4.75.8H192.86V72.54H218.2Z"/><path d="M90.43,145a2.42,2.42,0,0,1-2.38,2.39H38.82A2.42,2.42,0,0,1,36.44,145a2.37,2.37,0,0,1,2.38-2.38H61.06V102.1H42.71a2.38,2.38,0,0,1,0-4.76H84.16a2.38,2.38,0,0,1,0,4.76H65.81v40.56H88.05A2.37,2.37,0,0,1,90.43,145Z"/><path d="M179.66,118.71c2,1.85,7.52,8,8.78,9.66l-2.71,3.44a77.81,77.81,0,0,0-6.07-8.6v29.11h-4.29v-29.9c-2.37,6.88-5.54,13.69-8.58,17.86a18.54,18.54,0,0,0-2.37-4c3.82-5,8.05-14,10.29-21.9h-9.57v-4.17h10.23V98.86c-3,.93-6.14,1.72-9.11,2.39A10.55,10.55,0,0,0,164.81,98c7.26-1.78,15.51-4.43,20-7.21l3.89,3.31a2,2,0,0,1-1.32.26,47.88,47.88,0,0,1-7.72,3.18v12.7h8.65v4.17h-8.65Zm28.71,28.39h17.82v3.77H185.8V147.1h18.28v-5.76H189.3V137.7h14.78V133h-13.4V111.7h13.4v-4.63h-16.3v-3.71h16.3V97.67c-4.69.6-9.5,1.06-14,1.39A12.33,12.33,0,0,0,189,95.75c10.89-.92,23.89-2.64,30.62-4.89l3.69,3.31a.9.9,0,0,1-.72.26,1.57,1.57,0,0,1-.53-.07,97.42,97.42,0,0,1-13.66,2.72v6.28h17.16v3.71H208.37v4.63h14V133h-14v4.7h15.24v3.64H208.37Zm-13.66-32v5.49h9.37v-5.49Zm0,14.42h9.37v-5.62h-9.37Zm23.43-14.42h-9.77v5.49h9.77Zm0,14.42v-5.62h-9.77v5.62Z"/><path d="M52,196.58l-6.4,2.31v20.25c0,5-2.45,5.49-10.5,5.36a16.47,16.47,0,0,0-1.32-4.17c1.78.07,3.43.13,4.62.13,2.71,0,3,0,3-1.32V200.35c-2.44.92-4.69,1.72-6.54,2.31a1.2,1.2,0,0,1-.85,1.06l-1.59-5c2.44-.66,5.55-1.65,9-2.71V181H33.14v-4.17h8.32V163l5.41.33c-.07.53-.4.8-1.25.93v12.57h6.53V181H45.62v13.63l5.8-1.85Zm42.23-3.91H72v32H68.19V218c-5.94.86-11.75,1.59-15.58,2a1.2,1.2,0,0,1-.92.93l-1.52-4.63c1.65-.14,3.5-.27,5.48-.47V192.67H51.16V189H94.25ZM88.91,165v19.92H57.3V165ZM68.19,197.77v-5.1H59.41v5.1Zm-8.78,3.31v5.22h8.78v-5.22Zm0,8.46v5.89c2.77-.33,5.74-.59,8.78-.92v-5Zm25.21-36.25v-5H61.45v5Zm0,8.27V176.4H61.45v5.16Zm5.67,15.35,2.38.73c-.07.33-.26.53-.33.79a42.14,42.14,0,0,1-6.53,16.41,25.63,25.63,0,0,0,9.1,6.61,13.89,13.89,0,0,0-2.64,3.18,30,30,0,0,1-8.84-6.82,30.16,30.16,0,0,1-8.65,6.69,11.93,11.93,0,0,0-2.3-3.18A24.56,24.56,0,0,0,81,214.71a41.88,41.88,0,0,1-5.94-12.38l3.36-.92A35.85,35.85,0,0,0,83.3,211.6a37.36,37.36,0,0,0,4.62-10.92H73.27V197H89.63Z"/><path d="M111.15,212.06c-.13.4-.59.59-1.32.59a36.37,36.37,0,0,1-7.78,9.8,20.87,20.87,0,0,0-3-2.19,29.16,29.16,0,0,0,7.39-9.72Zm26.14-24.35v3.64H99.21v-3.64h17v-4.43H103.76V165.55h29.5v17.73H121.51c-.13.4-.46.73-1.25.79v3.64Zm-4.56,20.91H120.26v11.44c0,3.91-1.45,4.44-10.36,4.44a19.57,19.57,0,0,0-1.72-3.58c8,.14,8,.07,8-.86V208.62H104.29V195.45h28.44Zm-24.94-40.1V173H129.1v-4.44Zm0,7.28v4.5H129.1v-4.5Zm.46,23v6.62h20.33v-6.62ZM132,221.65a56.83,56.83,0,0,0-7.06-9.26l3.36-1.72a55.81,55.81,0,0,1,7.2,9.06Zm29.63-17.53a1.22,1.22,0,0,1-1.25.53c-4.95,7.67-13.86,15.28-23.17,19.85A22.23,22.23,0,0,0,134,221c8.91-4,17.82-11.18,22.5-18.79Zm-3.63-38a1.25,1.25,0,0,1-1.32.6,67.37,67.37,0,0,1-17,14.82,16.23,16.23,0,0,0-3.23-3.11c5.8-3.24,12.6-8.93,16.36-14.16Zm1.85,18.53a1.3,1.3,0,0,1-1.26.59,75,75,0,0,1-18.67,15.62,18.13,18.13,0,0,0-3.24-3.18c6.4-3.44,13.93-9.39,18.15-14.95Z"/><path d="M174.12,214.56V172.65a5,5,0,0,1,5-5h32.6a5,5,0,0,1,5,5v41.91a5,5,0,0,1-5,5h-32.6A5,5,0,0,1,174.12,214.56ZM212,190.62v-18a.25.25,0,0,0-.27-.26h-32.6a.25.25,0,0,0-.26.26v18Zm-.27,24.2a.25.25,0,0,0,.27-.26V195.38H178.87v19.18a.25.25,0,0,0,.26.26Z"/></svg>`,
      inputs: [
        {
          label: "工事名",
          type: "text",
          maxRow: 8,
          maxCol: 1,
          value: "",
          offsetX: 90,
          offsetY: 10,
        },
        {
          label: "工種",
          type: "text",
          maxRow: 8,
          maxCol: 1,
          value: "",
          offsetX: 90,
          offsetY: 30,
        },
        {
          label: "撮影日",
          type: "text",
          maxRow: 8,
          maxCol: 4,
          value: "",
          offsetX: 90,
          offsetY: 50,
        },
        {
          label: "自由記入欄",
          type: "text",
          maxRow: 8,
          maxCol: 4,
          value: "",
          offsetX: 50,
          offsetY: 50,
        },
      ],
      active: true,
    },
    {
      id: 1,
      name: "黒板1",
      svgCode: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 480"><rect width="640" height="480" style="fill:#004f37"/><path d="M624,16V464H16V16H624m4-4H12V468H628V12Z" style="fill:#fff"/><line x1="12" y1="83.5" x2="628" y2="83.5" style="fill:none;stroke:#fff;stroke-miterlimit:10;stroke-width:2px"/><line x1="12" y1="155.5" x2="628" y2="155.5" style="fill:none;stroke:#fff;stroke-miterlimit:10;stroke-width:2px"/><line x1="12" y1="227.5" x2="628" y2="227.5" style="fill:none;stroke:#fff;stroke-miterlimit:10;stroke-width:2px"/><line x1="252" y1="227" x2="252" y2="12" style="fill:none;stroke:#fff;stroke-miterlimit:10;stroke-width:2px"/><path d="M90.43,72.87a2.41,2.41,0,0,1-2.38,2.38H38.82a2.41,2.41,0,0,1-2.38-2.38,2.37,2.37,0,0,1,2.38-2.38H61.06V29.93H42.71a2.38,2.38,0,0,1,0-4.76H84.16a2.38,2.38,0,0,1,0,4.76H65.81V70.49H88.05A2.37,2.37,0,0,1,90.43,72.87Z" style="fill:#fff"/><path d="M160.45,57.72a2.36,2.36,0,0,1-2.37,2.38H153v3.84a4,4,0,0,1-4,4H131.81v6.61a6,6,0,0,1-2.18,4.7,6.07,6.07,0,0,1-3.89,1.39,6,6,0,0,1-1.12-.07,30.33,30.33,0,0,1-8.91-3.3,2.36,2.36,0,0,1-.93-3.25,2.31,2.31,0,0,1,3.17-.92,24.73,24.73,0,0,0,7.52,2.78,1.39,1.39,0,0,0,1.13-.27,1.43,1.43,0,0,0,.46-1.06V67.91H108.18a2.39,2.39,0,0,1,0-4.77h18.88v-3H100.79a2.36,2.36,0,0,1-2.37-2.38,2.4,2.4,0,0,1,2.37-2.38h26.27v-3H108.18a2.38,2.38,0,0,1,0-4.76h18.88V44.82H109.77a4,4,0,0,1-4-4v-5.3a4,4,0,0,1,4-4h17.29V28.81H103.37a2.39,2.39,0,0,1,0-4.77h23.69V20.73a2.38,2.38,0,1,1,4.75,0V24H155.5a2.39,2.39,0,0,1,0,4.77H131.81v2.77H149.1a4,4,0,0,1,4,4v5.3a4,4,0,0,1-4,4H131.81V47.6H149a4,4,0,0,1,4,4v3.77h5.09A2.4,2.4,0,0,1,160.45,57.72ZM127.06,40.05v-3.7h-16.5v3.7Zm4.75-3.7v3.7h16.5v-3.7Zm0,19h16.43v-3H131.81Zm16.43,4.76H131.81v3h16.43Z" style="fill:#fff"/><path d="M223,54.87V73.33a4,4,0,0,1-4,4H192.07a4,4,0,0,1-4-4V54.87a3.84,3.84,0,0,1,1.58-3.11,113.73,113.73,0,0,1-20.13,10.06,3.57,3.57,0,0,1-.85.13,2.4,2.4,0,0,1-.79-4.63,99.2,99.2,0,0,0,13.92-6.48c3.7-2.05,7.39-4.37,10.95-6.82a46.59,46.59,0,0,0-8.31-7.41,2.37,2.37,0,0,1,2.71-3.9,50.28,50.28,0,0,1,9.43,8.53,91.22,91.22,0,0,0,10-8.66,30.74,30.74,0,0,0,6-8H192.46a59,59,0,0,1-18.28,11.25,2.47,2.47,0,0,1-3.1-1.32,2.42,2.42,0,0,1,1.32-3.11,53.59,53.59,0,0,0,17-10.39,4.12,4.12,0,0,1,3-1.19H213a4.47,4.47,0,0,1,3.76,2.05,4.41,4.41,0,0,1,.4,4.23c-3.3,7.61-13.2,15.68-18.88,19.85a.84.84,0,0,1-.26.2l-.27.26a1.85,1.85,0,0,1-.52.27c-2.25,1.65-4.56,3.17-6.87,4.7a3.85,3.85,0,0,1,1.72-.47H219A4,4,0,0,1,223,54.87Zm-4.75.8H192.86V72.54H218.2Z" style="fill:#fff"/><path d="M90.43,145a2.42,2.42,0,0,1-2.38,2.39H38.82A2.42,2.42,0,0,1,36.44,145a2.37,2.37,0,0,1,2.38-2.38H61.06V102.1H42.71a2.38,2.38,0,0,1,0-4.76H84.16a2.38,2.38,0,0,1,0,4.76H65.81v40.56H88.05A2.37,2.37,0,0,1,90.43,145Z" style="fill:#fff"/><path d="M179.66,118.71c2,1.85,7.53,8,8.78,9.66l-2.71,3.44a76.48,76.48,0,0,0-6.07-8.6v29.11h-4.29v-29.9c-2.37,6.88-5.54,13.69-8.58,17.86a18.54,18.54,0,0,0-2.37-4c3.83-5,8.05-14,10.29-21.9h-9.57v-4.17h10.23V98.86c-3,.93-6.14,1.72-9.1,2.39A10.82,10.82,0,0,0,164.81,98c7.26-1.78,15.51-4.43,20-7.21l3.89,3.31a2,2,0,0,1-1.32.26,47.88,47.88,0,0,1-7.72,3.18v12.7h8.65v4.17h-8.65Zm28.71,28.39h17.82v3.77H185.8V147.1h18.28v-5.76H189.3V137.7h14.78V133h-13.4V111.7h13.4v-4.63h-16.3v-3.71h16.3V97.67c-4.69.6-9.5,1.06-14,1.39A12.33,12.33,0,0,0,189,95.75c10.89-.92,23.89-2.64,30.62-4.89l3.69,3.31a.9.9,0,0,1-.72.26,1.57,1.57,0,0,1-.53-.07,97.42,97.42,0,0,1-13.66,2.72v6.28h17.16v3.71H208.37v4.63h14V133h-14v4.7h15.24v3.64H208.37Zm-13.66-32v5.49h9.37v-5.49Zm0,14.42h9.37v-5.62h-9.37Zm23.43-14.42h-9.77v5.49h9.77Zm0,14.42v-5.62h-9.77v5.62Z" style="fill:#fff"/><path d="M43.77,191.68A48.26,48.26,0,0,0,32.68,185l2.44-3.24A42.2,42.2,0,0,1,46.28,188Zm-9.7,29.51a223.43,223.43,0,0,0,9.43-21.44l3.5,2.38a205.33,205.33,0,0,1-8.45,20.12,1.87,1.87,0,0,1,.4,1.06,1.32,1.32,0,0,1-.2.66Zm12.07-47a45.09,45.09,0,0,0-10.56-7.27l2.58-3.18a46.85,46.85,0,0,1,10.69,6.88ZM59,211.13a1.28,1.28,0,0,1-1.38.6,48.34,48.34,0,0,1-9.51,12.9,25.22,25.22,0,0,0-3.3-2.45,39.36,39.36,0,0,0,9.11-12.7Zm-8-45H70.3v42.08H51Zm3.89,4v8.8H66.27v-8.8Zm0,12.57v8.8H66.27v-8.8Zm0,12.57v8.93H66.27v-8.93ZM70.5,222.05a75.2,75.2,0,0,0-7.59-10.39l3.3-2a75.12,75.12,0,0,1,7.72,10.06ZM75.71,170l5.21.33c-.06.4-.46.73-1.25.86v37.12h-4ZM87.46,163l5.41.33c-.07.47-.4.8-1.32.86v54.52c0,5.49-2.38,5.76-13,5.76a20.4,20.4,0,0,0-1.39-4.3c2.38.06,4.62.13,6.27.13,3.5,0,4,0,4-1.59Z" style="fill:#fff"/><path d="M178.47,210.14c-2,5.43-5.54,11.18-9.7,14.49l-4-2.12c4-2.91,7.59-8.27,9.57-13.56ZM217.74,183v21.84H173.19V183h19.47V163l5.81.33c-.07.46-.46.79-1.39.92v6.29h25.68v4.23H197.08V183Zm-4.49,17.67v-13.5H177.48v13.5Zm-26.46,23.09a78.24,78.24,0,0,0-1.45-13.17l4.22-.33a73.8,73.8,0,0,1,1.72,12.9Zm16.76-.07a65.14,65.14,0,0,0-4.75-13l4.09-.93a64.38,64.38,0,0,1,5,12.83Zm18.88.73c-1.92-4-6.4-9.92-10.43-14.29l4-1.79c4,4.24,8.64,10.06,10.62,14Z" style="fill:#fff"/></svg>`,
      inputs: [
        {
          label: "工事名",
          type: "text",
          maxRow: 8,
          maxCol: 1,
          value: "",
          offsetX: 50,
          offsetY: 50,
        },
        {
          label: "工種",
          type: "text",
          maxRow: 8,
          maxCol: 1,
          value: "",
          offsetX: 50,
          offsetY: 50,
        },
        {
          label: "側点",
          type: "text",
          maxRow: 8,
          maxCol: 4,
          value: "",
          offsetX: 50,
          offsetY: 50,
        },
      ],
      active: false,
    },
  ]);
  const inputRef = useRef(null);

  const handleChangeFile = (files) => {
    // const files = e.target.files;
    // console.table(files);
    // TODO: 画像判定入れる
    if (!files.length) {
      // setImageFile("");
      return;
    }
    const imageUrl = createObjectURL(files[0]);
    console.log({ imageFile });
    const image = new Image();
    image.src = imageUrl;
    image.onload = () => {
      const newImage = {
        src: imageUrl,
        width: image.width,
        height: image.height,
      };
      setImageFile(newImage);
    };
  };

  const clearImageSrc = (fileInput) => {
    if (fileInput) {
      fileInput.value = null;
    }
    // fileInput.files = []
    // fileInput.reset()
    // fileInput.ref = null
    setImageFile(imageFileInitialValue);
  };

  const updateBoardSelect = (e) => {
    const targetID = Number(e.target.value);
    const updated = boardFormat
      .slice()
      .map((board) => Object.assign(board, { active: board.id === targetID }));
    setBoard(updated);
  };

  const updateInput = (value, i, activeBoardID) => {
    const updated = boardFormat.slice();
    updated[activeBoardID].inputs[i].value = value;
    setBoard(updated);
    console.log(boardFormat);
  };

  return (
    <div className="App">
      <header className="App-header">
        <ImageUploadForm
          inputRef={inputRef}
          clearImageSrc={clearImageSrc}
          handleChangeFile={handleChangeFile}
        />
        <ImageCanvas
          imageFile={imageFile}
          boardFormat={boardFormat}
          // updateCanvas={updateCanvas}
        />
        <Controller
          boardFormat={boardFormat}
          updateBoardSelect={updateBoardSelect}
          updateInput={updateInput}
        />
      </header>
    </div>
  );
};

export default App;
